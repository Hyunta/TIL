# 소개

은행앱에서 기간을 조회할 때 무한 스크롤이 구현되어있는 경우는 거의 없습니다. 대부분 기간을 설정해서 특정 기간동안 조회하도록 설정되어있습니다. 이는 코어뱅크 시스템에서 전체를 조회하게 될 경우 DB 부하가 너무 심하게 발생하기 때문인데요 이를 어떻게 해결할 수 있을지 영상을 보면서 내용을 정리해봤습니다.

이 글은 [해당 영상](https://youtu.be/v9rcKpUZw4o)을 보고 정리한 내용입니다.



# 문제 해결

1. 근본적인 문제 해결 - DB 분리

우선 서버를 하나 만들어서 계정에 관련된 정보를 미리 받아두면서 이를 해결할 수 있습니다.

미리 계정계에서 거래내역을 받아서 체널계에 DB를 붙입니다.

앞으로 일어나는 송금 내역에 대해서는 체널계 DB에도 저장합니다.

사용자가 거래내역을 조회할 때 체널계의 DB를 조회하면 됩니다.



2. 타행 입금시 조회 불가능한 문제

DB를 분리해서 관리하게 되면 타행에서 일어난 입금내역을 파악할 수 없습니다.

이를 개선하기 위해 계정계에 Kafka를 통해서 메시지를 받습니다.

송금 내역이 발생하면 메시지를 Consume해서 DB에 반영합니다.



3. 송금 완료 응답에서 Timeout이 발생하면?

정상적으로 송금을 보냈는데 만약 Timeout에 걸려서 완료 응답이 오지 않는다면 조회가 안됩니다.

하지만 어차피 송금이 완료되면 카프카 메시지로 전달받기 때문에 이를 DB에 반영하면 됩니다.

처음에는 에러를 응답하고 이후에 조회했을 때는 정상적으로 조회 가능합니다.



4. 만약 에러가 발생해서 사용자가 또 송금을 하게되면?

사용 요청이 있는 경우 송금을 거절합니다.

송금이 완료되고나서 나중에 요청을 수락합니다.



5. 만약 송금완료처리가 안되면 해당 사용자는 평생 송금을 못합니다.

체널계에서 주기적으로 계정계를 조회해서 만약 현재 진행중인 작업이 없다면, 요청중인 작업을 실패처리합니다.

이후에 사용자는 재요청할 수 있습니다.



6. 만약 송금 성공인데, 실패처리를 해버리면?

이런 경우를 방지하기 위해서 송금요청을 보낼 때 Timeout을 걸어서 보냅니다. 계정계에서 Timeout보다 클 경우 거절하도록 합니다.



---

1. 동기화 중에 저장하다가 실패하면 어떻게 하나요?

송금 서버는 다시 완료처리 컨슘 가능합니다. 하지만 계속 같은 문제가 발생할 수 있습니다.

Consumer Dead Letter로 분류하고 개발자가 따로 처리합니다.



2. 만약 동기화 내역이 누락되면 어떻게 하나요?

동기화 중에 에러가 발생하면 재시도 할 것입니다.

값을 갱신할 때 일련번호를 통해서 이전 값들이 전부 동기화 되어있는지 확인합니다.



3. 만약 동기화가 또 실패하면 어떻게 하나요?

최근 동기화도 진행하지 않고 둘다 실패하도록 합니다.

동기화전에 사용자는 두 내역 모두 조회할 수 없게 됩니다.

최후의 수단으로 유저가 동기화 버튼을 눌러서 불러올 수 있도록 합니다.



---

1. 만약 100만명에게 동시에 100원을 주면 어떻게 처리하나요?

카프카를 여러 파티션으로 나눠서 여러 컨슈머가 처리하도록 합니다. 계좌번호를 키로 삼아서 같은 거래는 같은 파티션에 적재할 수 있도록 합니다.



2. 만약 유저가 너무 늘어나면 어떡하죠?

파티션은 한번 늘리면 줄일 수 없습니다. 따라서 컨슈머의 워커쓰레드를 늘립니다. 마찬가지로 컨슈머의 워커쓰레드에는 계좌마다의 거래내역이 같이 입력되도록 합니다. 그래야 동기화 문제가 발생하지않습니다.

파티션 10개에 컨슈머 10개 워커쓰레드를 100개 두면 초당 1만건씩 처리가 가능해집니다.



